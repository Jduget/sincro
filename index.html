<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de TipoDocumentos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para la fuente Inter, preferida por Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Añadimos un estilo para que el textarea parezca de código */
        #doc-data {
            font-family: monospace;
        }
    </style>
    <!-- Importar la fuente Inter -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Pantalla de Login (Visible por defecto) -->
    <div id="login-container" class="container mx-auto p-8 max-w-md mt-20 bg-white rounded-lg shadow-xl text-center">
        <h1 class="text-3xl font-bold mb-6 text-blue-700">Editor de Documentos</h1>
        <p class="text-gray-600 mb-8">Debes iniciar sesión con Google para continuar.</p>
        <button id="btn-login-google"
                class="w-full bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-md font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center gap-3">
            <!-- Icono de Google SVG -->
            <svg class="w-5 h-5" viewBox="0 0 48 48">
                <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.06 6.25C12.7 13.01 17.9 9.5 24 9.5z"></path>
                <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.82-2.2 5.23-4.51 6.84l7.66 5.92C44.64 36.21 46.98 30.77 46.98 24.55z"></path>
                <path fill="#FBBC05" d="M10.62 28.32c-.3-.9-.47-1.85-.47-2.82s.17-1.92.47-2.82l-8.06-6.25C.96 18.25 0 21.01 0 24s.96 5.75 2.56 7.49l8.06-6.17z"></path>
                <path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.66-5.92c-2.11 1.41-4.79 2.26-7.9 2.26-6.1 0-11.3-3.51-13.2-8.28l-8.06 6.25C6.51 42.62 14.62 48 24 48z"></path>
                <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>
            Iniciar sesión con Google
        </button>
    </div>

    <!-- Contenedor Principal de la App (Oculto por defecto) -->
    <div id="content-container" class="container mx-auto p-4 md:p-8 max-w-6xl hidden">
        
        <!-- Encabezado con info de usuario y logout -->
        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
            <h1 class="text-3xl font-bold text-blue-700">Editor de "TipoDocumentos"</h1>
            <div class="flex items-center">
                <span id="user-info" class="text-sm text-gray-600 mr-4"></span>
                <button id="btn-logout"
                        class="bg-red-500 text-white px-4 py-2 rounded-md font-medium hover:bg-red-600 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Cerrar Sesión
                </button>
            </div>
        </div>

        <p class="mb-6 text-gray-600">
            Proyecto: <code id="project-id" class="bg-gray-200 px-2 py-1 rounded">ia-inmobiliaria</code>
        </p>

        <!-- Contenedor principal: Lista a la izquierda, formulario a la derecha -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Columna 1: Lista de Documentos -->
            <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Documentos Existentes</h2>
                <div id="doc-list" class="flex flex-col space-y-2 max-h-screen overflow-y-auto">
                    <!-- Los documentos se cargarán aquí -->
                    <p id="list-loading" class="text-gray-500">Cargando lista...</p>
                </div>
            </div>

            <!-- Columna 2: Formulario de Edición -->
            <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Editor de Documento</h2>
                <form id="doc-form">
                    <div class="mb-4">
                        <label for="doc-id" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre del Documento (ID)
                        </label>
                        <input type="text" id="doc-id" name="doc-id"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ej: Contrato de Arriendo" required>
                    </div>

                    <div class="mb-4">
                        <label for="doc-data" class="block text-sm font-medium text-gray-700 mb-1">
                            Datos del Documento (en formato JSON)
                        </label>
                        <textarea id="doc-data" name="doc-data" rows="12"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  placeholder='{
    "descripcion": "Plantilla para...",
    "version": 1.2,
    "campos_requeridos": ["nombre", "rut"]
}'></textarea>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="flex flex-wrap gap-3">
                        <button type="button" id="btn-load"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Cargar
                        </button>
                        <button type="submit" id="btn-save"
                                class="bg-green-600 text-white px-4 py-2 rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            Crear / Actualizar
                        </button>
                        <button type="button" id="btn-delete"
                                class="bg-red-600 text-white px-4 py-2 rounded-md font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                            Eliminar
                        </button>
                        <button type="button" id="btn-clear"
                                class="bg-gray-500 text-white px-4 py-2 rounded-md font-medium hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                            Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mensajes de Estado -->
        <div id="status-message" class="mt-6 p-4 rounded-md text-sm transition-opacity duration-300 opacity-0">
            <!-- Los mensajes de éxito o error aparecerán aquí -->
        </div>

    </div> <!-- fin #content-container -->

    <!-- Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signInWithCustomToken,
            GoogleAuthProvider, // <--- AÑADIDO
            signInWithPopup,    // <--- AÑADIDO
            signOut             // <--- AÑADIDO
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            collection, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (proporcionada por el entorno) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                // Fallback de configuración (para desarrollo local)
                apiKey: "AIzaSyBRk8QzWMAd8sErwFtb8AsCldQTMMZ9yrU",
                authDomain: "iainmobiliaria.firebaseapp.com",
                projectId: "iainmobiliaria",
                storageBucket: "iainmobiliaria.firebasestorage.app",
                messagingSenderId: "259064802355",
                appId: "1:259064802355:web:d0aa9d10bca1a6025e4746"
            };

        // --- Variables Globales de la App ---
        const COLLECTION_NAME = "TipoDocumentos";
        let db, auth;
        let collectionPath = ""; // Se definirá después de la autenticación
        let unsubscribeFromDocuments = null; // Para detener el listener al cerrar sesión

        // --- Referencias a elementos del DOM ---
        // Contenedores
        const loginContainer = document.getElementById("login-container");
        const contentContainer = document.getElementById("content-container");
        
        // Formulario y lista
        const docList = document.getElementById("doc-list");
        const listLoading = document.getElementById("list-loading");
        const docIdInput = document.getElementById("doc-id");
        const docDataTextarea = document.getElementById("doc-data");
        const statusMessage = document.getElementById("status-message");
        const docForm = document.getElementById("doc-form");
        const projectIdElement = document.getElementById("project-id");

        // Botones de Acción
        const btnLoad = document.getElementById("btn-load");
        const btnSave = document.getElementById("btn-save");
        const btnDelete = document.getElementById("btn-delete");
        const btnClear = document.getElementById("btn-clear");
        
        // Botones de Auth
        const btnLoginGoogle = document.getElementById("btn-login-google");
        const btnLogout = document.getElementById("btn-logout");
        const userInfo = document.getElementById("user-info");


        /**
         * Muestra un mensaje de estado al usuario.
         * @param {string} message - El mensaje a mostrar.
         * @param {boolean} isError - true si es un error, false si es éxito.
         */
        function showMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove("opacity-0");
            if (isError) {
                statusMessage.classList.remove("bg-green-100", "text-green-800");
                statusMessage.classList.add("bg-red-100", "text-red-800");
            } else {
                statusMessage.classList.remove("bg-red-100", "text-red-800");
                statusMessage.classList.add("bg-green-100", "text-green-800");
            }
            // Ocultar el mensaje después de 5 segundos
            setTimeout(() => {
                statusMessage.classList.add("opacity-0");
            }, 5000);
        }

        /**
         * Limpia el formulario.
         */
        function handleClearForm() {
            docForm.reset();
            docIdInput.disabled = false;
        }

        /**
         * Carga los datos de un documento en el formulario.
         * @param {string} [id] - El ID del documento a cargar. Si está vacío, usa el valor del input.
         */
        async function handleLoadDocument(id) {
            const docId = id || docIdInput.value;
            if (!docId) {
                showMessage("Por favor, introduce un ID de documento para cargar.", true);
                return;
            }

            try {
                const docRef = doc(db, collectionPath, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    docIdInput.value = docSnap.id;
                    docIdInput.disabled = true; // Deshabilitar ID al cargar para evitar cambios
                    docDataTextarea.value = JSON.stringify(docSnap.data(), null, 2);
                    showMessage(`Documento "${docId}" cargado correctamente.`, false);
                } else {
                    showMessage(`El documento con ID "${docId}" no existe.`, true);
                }
            } catch (error) {
                console.error("Error al cargar documento: ", error);
                showMessage(`Error al cargar documento: ${error.message}`, true);
            }
        }

        /**
         * Guarda (Crea o Actualiza) un documento.
         */
        async function handleSaveDocument(event) {
            event.preventDefault(); 
            
            const docId = docIdInput.value;
            const docDataString = docDataTextarea.value;

            if (!docId) {
                showMessage("El Nombre del Documento (ID) no puede estar vacío.", true);
                return;
            }

            let jsonData;
            try {
                jsonData = docDataString ? JSON.parse(docDataString) : {};
            } catch (error) {
                showMessage(`Los datos no son un JSON válido: ${error.message}`, true);
                return;
            }

            try {
                const docRef = doc(db, collectionPath, docId);
                await setDoc(docRef, jsonData);
                
                showMessage(`Documento "${docId}" guardado correctamente.`, false);
                handleClearForm(); 
            } catch (error) {
                console.error("Error al guardar documento: ", error);
                showMessage(`Error al guardar documento: ${error.message}`, true);
            }
        }

        /**
         * Elimina un documento.
         */
        async function handleDeleteDocument() {
            const docId = docIdInput.value;
            if (!docId) {
                showMessage("Por favor, carga o introduce un ID de documento para eliminar.", true);
                return;
            }
            
            try {
                const docRef = doc(db, collectionPath, docId);
                await deleteDoc(docRef);

                showMessage(`Documento "${docId}" eliminado correctamente.`, false);
                handleClearForm();
            } catch (error) {
                console.error("Error al eliminar documento: ", error);
                showMessage(`Error al eliminar documento: ${error.message}`, true);
            }
        }

        /**
         * Escucha cambios en la colección y actualiza la lista.
         */
        function listenToDocuments() {
            // Si ya hay un listener, lo detenemos antes de crear uno nuevo
            if (unsubscribeFromDocuments) {
                unsubscribeFromDocuments();
            }

            const collectionRef = collection(db, collectionPath);
            
            // Guardamos la función 'unsubscribe'
            unsubscribeFromDocuments = onSnapshot(collectionRef, (snapshot) => {
                listLoading.style.display = 'none'; 
                docList.innerHTML = ''; 
                
                if (snapshot.empty) {
                    docList.innerHTML = '<p class="text-gray-500">No hay documentos en esta colección.</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const docEl = document.createElement("button");
                    docEl.type = "button";
                    docEl.textContent = doc.id;
                    docEl.setAttribute("data-id", doc.id);
                    docEl.className = "w-full text-left p-2 rounded-md bg-gray-50 hover:bg-blue-100 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500";
                    
                    docEl.addEventListener("click", () => {
                        handleLoadDocument(doc.id);
                    });
                    
                    docList.appendChild(docEl);
                });

            }, (error) => {
                console.error("Error al escuchar la colección: ", error);
                showMessage(`Error al cargar la lista de documentos: ${error.message}`, true);
                listLoading.style.display = 'none';
                docList.innerHTML = '<p class="text-red-500">Error al cargar la lista.</p>';
            });
        }

        /**
         * Detiene el listener de la colección.
         */
        function stopListeningToDocuments() {
            if (unsubscribeFromDocuments) {
                unsubscribeFromDocuments();
                unsubscribeFromDocuments = null;
            }
            docList.innerHTML = '<p id="list-loading" class="text-gray-500">Cargando lista...</p>';
            listLoading.style.display = 'block';
        }


        /**
         * Función principal de inicialización.
         */
        async function main() {
            // Actualizar UI con el projectId
            if (firebaseConfig.projectId) {
                projectIdElement.textContent = firebaseConfig.projectId;
            }
            
            // Inicializar Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setLogLevel('debug');

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                collectionPath = `artifacts/${appId}/public/data/${COLLECTION_NAME}`;
                console.log(`Ruta de la colección: ${collectionPath}`);

                // Configurar Listeners de botones de la App
                docForm.addEventListener("submit", handleSaveDocument);
                btnLoad.addEventListener("click", () => handleLoadDocument());
                btnDelete.addEventListener("click", handleDeleteDocument);
                btnClear.addEventListener("click", handleClearForm);

                // --- NUEVOS Listeners de Autenticación ---
                btnLoginGoogle.addEventListener("click", async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                        // onAuthStateChanged se encargará de mostrar la app
                    } catch (error) {
                        console.error("Error al iniciar sesión con Google:", error);
                        showMessage(`Error al iniciar sesión: ${error.message}`, true);
                    }
                });

                btnLogout.addEventListener("click", async () => {
                    try {
                        await signOut(auth);
                        // onAuthStateChanged se encargará de ocultar la app
                    } catch (error) {
                        console.error("Error al cerrar sesión:", error);
                        showMessage(`Error al cerrar sesión: ${error.message}`, true);
                    }
                });


                // --- Autenticación de Firebase (Lógica MODIFICADA) ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario ya autenticado
                        console.log("Usuario autenticado:", user.email);
                        
                        // Mostrar app, ocultar login
                        contentContainer.classList.remove("hidden");
                        loginContainer.classList.add("hidden");
                        userInfo.textContent = user.email; // Mostrar email

                        // Empezar a escuchar documentos
                        listenToDocuments();
                    } else {
                        // Usuario no autenticado
                        console.log("Sin usuario, esperando inicio de sesión.");

                        // Mostrar login, ocultar app
                        contentContainer.classList.add("hidden");
                        loginContainer.classList.remove("hidden");
                        userInfo.textContent = "";

                        // Detener la escucha de documentos
                        stopListeningToDocuments();
                        handleClearForm(); // Limpiar formulario

                        // Intentar login con token solo si estamos en Canvas
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Iniciando sesión con Custom Token (Canvas)...");
                                await signInWithCustomToken(auth, __initial_auth_token);
                            }
                        } catch (error) {
                            console.error("Error de autenticación con Custom Token:", error);
                            // No mostramos error, solo esperamos que el usuario use Google
                        }
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessage(`No se pudo inicializar Firebase. Revisa la configuración. ${error.message}`, true);
            }
        }

        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener("DOMContentLoaded", main);

    </script>
</body>
</html>
